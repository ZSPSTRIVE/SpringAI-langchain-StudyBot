<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>评论</title>
	<link rel="stylesheet" href="../../layui/css/layui.css">
	<link rel="stylesheet" href="../../css/style.css" />
	<link rel="stylesheet" href="../../css/theme.css" />
	<link rel="stylesheet" href="../../css/common.css" />
	<style>
		html, body, #app, .layui-form {
			height: 100%;
		}
		.layui-form {
			height: 100%;
			margin: 0 !important;
			box-sizing: border-box;
		}
		.forum-container {
			margin: 0 auto !important;
			box-sizing: border-box;
		}
		.forum-container .layui-form-item {
			display: flex;
			align-items: center;
		}
		.forum-container .layui-input-block {
			margin: 0;
			flex: 1;
		}
		.forum-container .input .layui-input {
			padding: 0 12px;
			height: 40px;
			font-size: 14px;
			color: #333;
			border-radius: 4px;
			border-width: 1px;
			border-style: solid;
			border-color: #DCDFE6;
			background-color: #fff;
			box-shadow: 0 0 0px rgba(255,0,0,.8);
			text-align: left;
		}
	</style>
</head>
<body>
<div id="app">
	<form class="layui-form message-form" :style='{"padding":"20px","boxShadow":"1px 0 6px rgba(153, 204, 0, 1)","margin":"0 0 20px 0","borderColor":"rgba(153, 204, 0, 1)","backgroundColor":"#fff","borderRadius":"4px","borderWidth":"2px","borderStyle":"solid"}'>
		<div class="layui-form-item layui-form-text" style="display: flex;align-items: start;margin:0">
			<label style="width: auto;" :style='{"padding":"0","minWidth":"54px","fontSize":"14px","color":"#333","textAlign":"center"}' class="layui-form-label">评论</label>
			<div class="layui-input-block" style="margin:0;flex:1;">
				<textarea id="content" name="content"></textarea>
			</div>
		</div>

		<div class="layui-form-item">
			<div class="layui-input-block" style="text-align: right;margin-right: 30px;">
				<button style="outline:none" :style='{"padding":"0 10px","boxShadow":"0 0 0px rgba(255,0,0,.5)","margin":"10px 20px 0","borderColor":"#ccc","backgroundColor":"rgba(153, 204, 0, 1)","color":"#fff","borderRadius":"8px","borderWidth":"0","width":"200px","fontSize":"14px","borderStyle":"solid","height":"44px"}' class="layui-btn btn-submit" lay-submit lay-filter="*">评论</button>
				<button style="outline:none" :style='{"padding":"0 10px","boxShadow":"0 0 0px rgba(255,0,0,.5)","margin":"10px 0","borderColor":"rgba(146, 146, 146, 1)","backgroundColor":"rgba(162, 162, 162, 1)","color":"rgba(255, 255, 255, 1)","borderRadius":"8px","borderWidth":"0","width":"200px","fontSize":"14px","borderStyle":"solid","height":"44px"}' type="reset" class="layui-btn layui-btn-primary">重置</button>
			</div>
		</div>
	</form>
</div>

<script src="../../layui/layui.js"></script>
<script src="../../js/vue.js"></script>
<script src="../../js/config.js"></script>
<script src="../../modules/config.js"></script>
<script src="../../js/utils.js"></script>

<script>
	var vue = new Vue({
		el: '#app',
		data: {},
		methods: {
			jump(url) {
				jump(url)
			}
		}
	})

	layui.use(['layer', 'element', 'http', 'jquery', 'form', 'tinymce'], function() {
		var layer = layui.layer;
		var element = layui.element;
		var http = layui.http;
		var form = layui.form;
		var jquery = layui.jquery;
		var tinymce = layui.tinymce;

		// 初始化编辑器
		var edit = tinymce.render({
			elem: "#content",
			height: 600,
			images_upload_handler: function(blobInfo, succFun, failFun) {
				var xhr, formData;
				var file = blobInfo.blob(); //转化为易于理解的file对象
				xhr = new XMLHttpRequest();
				xhr.withCredentials = false;
				xhr.open('POST', http.baseurl + 'file/upload');
				xhr.setRequestHeader("Token", localStorage.getItem('Token')); //设置请求头
				xhr.onload = function() {
					var json;
					if (xhr.status != 200) {
						failFun('HTTP Error: ' + xhr.status);
						return;
					}
					json = JSON.parse(xhr.responseText);
					if (!json || typeof json.file != 'string') {
						failFun('Invalid JSON: ' + xhr.responseText);
						return;
					}
					succFun(http.baseurl + '/upload/' + json.file);
				};
				formData = new FormData();
				formData.append('file', file, file.name); //此处与源文档不一样
				xhr.send(formData);
			}
		}, (opt) => {

		});

		// 提交表单
		form.on('submit(*)', function(data) {
			data = data.field;
			// 获取富文本的内容
			var content = tinymce.get('#content').getContent()
			data.content = content;
			data.userid = localStorage.getItem('userid');
			data.username = localStorage.getItem('username');
			data.parentid = http.getParam('pid');
			
			http.requestJson('forum/add', 'post', data, function(res) {
				layer.msg('发表成功', {
					time: 2000,
					icon: 6
				}, function() {
					window.parent.location.reload();
				});
			});
			return false;
		});
	});
</script>
</body>
</html>