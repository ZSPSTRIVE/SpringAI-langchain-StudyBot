package com.qasystem.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.qasystem.entity.AiConversation;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Select;

import java.util.List;

/**
 * AiConversationMapperæ¥å£ - AIå¯¹è¯æ•°æ®è®¿é—®å±‚
 * 
 * ğŸ¯ ä½œç”¨è¯´æ˜ï¼š
 * è¿™ä¸ªæ¥å£è´Ÿè´£æ“ä½œæ•°æ®åº“ä¸­çš„ai_conversationè¡¨ï¼Œå°±åƒä¸€ä¸ª"AIå¯¹è¯è®°å½•ç®¡ç†å‘˜"ã€‚
 * ç®¡ç†ç€ç”¨æˆ·ä¸AIåŠ©æ‰‹çš„å¯¹è¯å†å²ï¼Œå°±åƒChatGPTçš„å¯¹è¯è®°å½•ã€‚
 * æ¯æ¬¡ç”¨æˆ·æé—®å’ŒAIå›ç­”éƒ½ä¼šä¿å­˜åœ¨è¿™é‡Œï¼Œæ–¹ä¾¿ç”¨æˆ·æŸ¥çœ‹å†å²å¯¹è¯ã€‚
 * 
 * ğŸ“š ç³»ç»Ÿä¸­çš„ä½œç”¨ï¼š
 * 1. ä¿å­˜AIå¯¹è¯ï¼šè®°å½•ç”¨æˆ·é—®é¢˜å’ŒAIå›ç­”
 * 2. æŸ¥çœ‹å†å²å¯¹è¯ï¼šç”¨æˆ·å¯ä»¥æŸ¥çœ‹ä¹‹å‰çš„å¯¹è¯è®°å½•
 * 3. ä¼šè¯ç®¡ç†ï¼šç®¡ç†å¤šä¸ªå¯¹è¯ä¼šè¯ï¼ˆå°±åƒChatGPTçš„ä¸åŒå¯¹è¯ï¼‰
 * 4. ä¸Šä¸‹æ–‡ç»§ç»­ï¼šç»§ç»­ä¹‹å‰çš„å¯¹è¯ï¼ŒAIèƒ½è®°ä½ä¸Šæ–‡
 * 
 * ğŸ—ï¸ æŠ€æœ¯æ¶æ„ï¼š
 * - ç»§æ‰¿è‡ªMyBatis-Plusçš„BaseMapper<AiConversation>
 * - BaseMapperæä¾›åŸºç¡€çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•
 * - æˆ‘ä»¬æ·»åŠ äº†2ä¸ªè‡ªå®šä¹‰SQLæŸ¥è¯¢æ–¹æ³•ï¼š
 *   1. getSessionHistoryï¼šæŸ¥è¯¢æŸä¸ªä¼šè¯çš„å®Œæ•´å†å²
 *   2. getUserSessionsï¼šæŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯åˆ—è¡¨
 * 
 * ğŸ“Š å¯¹åº”æ•°æ®åº“è¡¨: ai_conversation
 * 
 * ğŸ”— æ•°æ®ç»“æ„ï¼š
 * - å­—æ®µï¼šuser_id, session_id, session_title, user_message, ai_response, created_at
 * - session_idï¼šä¼šè¯æ ‡è¯†ï¼ŒåŒä¸€ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯å…±äº«åŒsession_id
 * - session_titleï¼šä¼šè¯æ ‡é¢˜ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ç®€è¦æ€»ç»“
 * 
 * ğŸ’¡ ä½¿ç”¨åœºæ™¯ï¼š
 * 1. ç”¨æˆ·å‘AIæé—®ï¼šä¿å­˜é—®é¢˜å’ŒAIå›ç­”
 * 2. æŸ¥çœ‹å†å²å¯¹è¯ï¼šæ˜¾ç¤ºæŸä¸ªä¼šè¯çš„å®Œæ•´è®°å½•
 * 3. ä¼šè¯åˆ—è¡¨ï¼šæ˜¾ç¤ºç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯ä¼šè¯
 * 4. ç»§ç»­å¯¹è¯ï¼šåŠ è½½ä¹‹å‰çš„å¯¹è¯ä¸Šä¸‹æ–‡
 * 
 * âš ï¸ é‡è¦æç¤ºï¼š
 * 1. @Selectæ³¨è§£ç›´æ¥åœ¨æ¥å£ä¸­ç¼–å†™SQLï¼Œè€Œä¸éœ€è¦XMLæ˜ å°„æ–‡ä»¶
 * 2. è¿™æ˜¯ä¸€ç§ç®€å•å¿«æ·çš„æ–¹å¼ï¼Œé€‚ç”¨äºç®€å•SQLæŸ¥è¯¢
 * 3. å¤æ‚SQLå»ºè®®ä½¿ç”¨XMLæ˜ å°„æ–‡ä»¶ï¼Œæ›´æ˜“äºç»´æŠ¤
 * 4. session_idç”¨äºåŒºåˆ†ä¸åŒçš„å¯¹è¯ä¼šè¯
 * 
 * @author QA System Team
 * @version 1.0
 */
@Mapper
public interface AiConversationMapper extends BaseMapper<AiConversation> {
    
    /**
     * è·å–ç”¨æˆ·çš„ä¼šè¯å†å²ï¼ˆæŒ‰æ—¶é—´å‡åºï¼‰
     * 
     * ğŸ¯ æ–¹æ³•ä½œç”¨ï¼š
     * æŸ¥è¯¢æŸä¸ªç”¨æˆ·åœ¨æŸä¸ªä¼šè¯ä¸­çš„å®Œæ•´å¯¹è¯å†å²ï¼ŒæŒ‰æ—¶é—´å‡åºæ’åˆ—ã€‚
     * å°±åƒåœ¨ChatGPTä¸­æ‰“å¼€ä¸€ä¸ªå¯¹è¯ï¼Œçœ‹åˆ°ä»å¤´åˆ°å°¾çš„æ‰€æœ‰é—®ç­”ã€‚
     * 
     * ğŸ” æŸ¥è¯¢é€»è¾‘ï¼š
     * - æŸ¥è¯¢æ¡ä»¶ï¼šuser_id = ? AND session_id = ?
     * - æ’åºæ–¹å¼ï¼šæŒ‰created_atå‡åºï¼ˆæœ€æ—©çš„æ¶ˆæ¯åœ¨å‰ï¼‰
     * - è¿™æ ·å¯ä»¥æŒ‰ç…§æ—¶é—´é¡ºåºå±•ç¤ºå¯¹è¯
     * 
     * ğŸ“ ä½¿ç”¨åœºæ™¯ï¼š
     * 1. åŠ è½½å¯¹è¯é¡µé¢ï¼šç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªå¯¹è¯ï¼ŒåŠ è½½å®Œæ•´å†å²
     * 2. ç»§ç»­å¯¹è¯ï¼šç»§ç»­ä¹‹å‰çš„å¯¹è¯ï¼ŒAIéœ€è¦äº†è§£ä¸Šä¸‹æ–‡
     * 3. å¯¼å‡ºå¯¹è¯ï¼šç”¨æˆ·å¯¼å‡ºå¯¹è¯è®°å½•
     * 
     * @param userId ç”¨æˆ·ID
     * @param sessionId ä¼šè¯æ ‡è¯†ï¼ˆUUIDæˆ–æ—¶é—´æˆ³ç”Ÿæˆï¼‰
     * @return List<AiConversation> å¯¹è¯è®°å½•åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´å‡åºï¼‰
     *         - åŒ…å«ç”¨æˆ·é—®é¢˜å’ŒAIå›ç­”
     *         - æŒ‰ç…§å¯¹è¯é¡ºåºæ’åˆ—
     */
    @Select("SELECT * FROM ai_conversation WHERE user_id = #{userId} AND session_id = #{sessionId} ORDER BY created_at ASC")
    List<AiConversation> getSessionHistory(Long userId, String sessionId);
    
    /**
     * è·å–ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯åˆ—è¡¨
     * 
     * ğŸ¯ æ–¹æ³•ä½œç”¨ï¼š
     * æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯ä¼šè¯ï¼Œæ¯ä¸ªä¼šè¯åªè¿”å›æœ€æ–°çš„ä¸€æ¡è®°å½•ã€‚
     * å°±åƒåœ¨ChatGPTå·¦ä¾§è¾¹æ ä¸­æ˜¾ç¤ºçš„å¯¹è¯åˆ—è¡¨ï¼Œæ¯ä¸ªå¯¹è¯æ˜¾ç¤ºæ ‡é¢˜å’Œæœ€åä¸€æ¬¡äº¤äº’æ—¶é—´ã€‚
     * 
     * ğŸ” æŸ¥è¯¢é€»è¾‘è¯¦è§£ï¼š
     * 
     * è¿™æ˜¯ä¸€ä¸ªå¤æ‚SQLï¼Œä½¿ç”¨äº†å­æŸ¥è¯¢å’Œå†…è¿æ¥ï¼š
     * 
     * 1. å­æŸ¥è¯¢ï¼ˆt2ï¼‰ï¼š
     *    - å¯¹ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯æŒ‰session_idåˆ†ç»„
     *    - æ‰¾å‡ºæ¯ä¸ªä¼šè¯ä¸­æœ€æ–°çš„ä¸€æ¡è®°å½•çš„æ—¶é—´ï¼ˆMAX(created_at)ï¼‰
     * 
     * 2. ä¸»æŸ¥è¯¢ï¼ˆt1ï¼‰ï¼š
     *    - æŸ¥è¯¢ai_conversationè¡¨
     *    - é€šè¿‡INNER JOINå…³è”å­æŸ¥è¯¢ç»“æœ
     *    - åªé€‰æ‹©æ¯ä¸ªä¼šè¯ä¸­æœ€æ–°çš„é‚£æ¡è®°å½•
     * 
     * 3. æ’åºå’Œé™åˆ¶ï¼š
     *    - æŒ‰created_até™åºæ’åˆ—ï¼ˆæœ€æ–°çš„ä¼šè¯åœ¨å‰ï¼‰
     *    - LIMIT #{limit}é™åˆ¶è¿”å›æ•°é‡ï¼ˆä¾‹å¦‚20ä¸ªæœ€è¿‘çš„ä¼šè¯ï¼‰
     * 
     * ğŸ“ ä½¿ç”¨åœºæ™¯ï¼š
     * 1. å¯¹è¯åˆ—è¡¨é¡µé¢ï¼šæ˜¾ç¤ºç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯
     * 2. ä¾§è¾¹æ å¯¼èˆªï¼šå°±åƒChatGPTå·¦ä¾§çš„å¯¹è¯åˆ—è¡¨
     * 3. å¯¹è¯ç®¡ç†ï¼šç”¨æˆ·å¯ä»¥é€‰æ‹©ã€åˆ é™¤ã€é‡å‘½åå¯¹è¯
     * 
     * ğŸ“ è¿”å›æ•°æ®ç¤ºä¾‹ï¼š
     * [
     *   {sessionId: "uuid-1", sessionTitle: "å¦‚ä½•å­¦ä¹ Java", userMessage: "æˆ‘æ˜¯åˆå­¦è€…...", createdAt: "2024-01-20"},
     *   {sessionId: "uuid-2", sessionTitle: "é«˜ç­‰æ•°å­¦é—®é¢˜", userMessage: "è¯·é—®å¯¼æ•°...", createdAt: "2024-01-19"},
     *   {sessionId: "uuid-3", sessionTitle: "ç¼–ç¨‹ç»ƒä¹ ", userMessage: "å†™ä¸€ä¸ªæ’åºç®—æ³•", createdAt: "2024-01-18"}
     * ]
     * 
     * @param userId ç”¨æˆ·ID
     * @param limit è¿”å›æ•°é‡é™åˆ¶ï¼ˆä¾‹å¦‚20ï¼‰
     * @return List<AiConversation> ä¼šè¯åˆ—è¡¨ï¼ˆæ¯ä¸ªä¼šè¯åªè¿”å›æœ€æ–°ä¸€æ¡ï¼‰
     *         - æŒ‰æ—¶é—´é™åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨æœ€å‰ï¼‰
     *         - åŒ…å«sessionId, sessionTitle, userMessage, createdAtç­‰å­—æ®µ
     * 
     * âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
     * 1. è¿™æ˜¯ä¸€ä¸ªå¤æ‚SQLï¼Œä½¿ç”¨äº†å­æŸ¥è¯¢å’ŒJOINï¼Œæ‰§è¡Œæ•ˆç‡éœ€è¦å…³æ³¨
     * 2. å»ºè®®åœ¨session_idå’Œuser_idä¸Šåˆ›å»ºç´¢å¼•ä»¥æé«˜æ€§èƒ½
     * 3. limitå‚æ•°åº”è¯¥æœ‰åˆç†çš„èŒƒå›´é™åˆ¶ï¼ˆ1-100ï¼‰
     * 4. å¦‚æœç”¨æˆ·æœ‰å¤§é‡å¯¹è¯ï¼Œå»ºè®®ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢
     * 5. sessionTitleé€šå¸¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ç®€è¦æ€»ç»“ï¼Œç”¨äºæ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­
     */
    @Select("""
        SELECT 
            t1.id,
            t1.session_id,
            t1.session_title,
            t1.user_message,
            t1.created_at
        FROM ai_conversation t1
        INNER JOIN (
            SELECT session_id, MAX(created_at) as max_created_at
            FROM ai_conversation
            WHERE user_id = #{userId}
            GROUP BY session_id
        ) t2 ON t1.session_id = t2.session_id AND t1.created_at = t2.max_created_at
        WHERE t1.user_id = #{userId}
        ORDER BY t1.created_at DESC
        LIMIT #{limit}
    """)
    List<AiConversation> getUserSessions(Long userId, Integer limit);
}
